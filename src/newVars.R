#######################
# Create new variables
######################
library(readxl)
library(readr)
library(dplyr)
library(lubridate)
GNSIS.1<-read_excel("GNSIS_DATABASE_v7.5.1_7.15.2020.xlsx",na=c("NA"),col_names = T)%>%
  filter(PAST_HEMORRHAGIC_STROKE_AT_INDEX==0 & PAST_ISCHEMIC_STROKE_AT_INDEX==0)
jiang.labs<-read_excel("jiangLabs.xlsx",na=c("NA"),col_names = T)
PRBLM_LIST_ADMSN_ENCS<-read_excel("STROKE_STRICT_PROBLEM_LIST.xlsx",sheet="ADMISION_ENCS",na=c("NA"),col_names = T)
PRBLM_LIST<-read_excel("STROKE_STRICT_PROBLEM_LIST.xlsx",sheet="PROBLEM_LIST",na=c("NA"),col_names = T)
colnames(PRBLM_LIST)[colnames(PRBLM_LIST)=='PROB_DT']<-'ENC_DT'
STROKE_STRICT_ALL_DXS <- read_table2("STROKE_STRICT_ALL_DXS.txt",
                                     col_types = cols(INDEX_DT = col_date(format = "%Y-%m-%d"),
                                                      ENC_DT = col_date(format = "%Y-%m-%d")))
STROKE_STRICT_ALL_DXS<-STROKE_STRICT_ALL_DXS[-1,]
ICD_Patients_ENCS<-rbind(
  PRBLM_LIST,
  PRBLM_LIST_ADMSN_ENCS%>%select("PT_ID","INDEX_DT","ENC_DT","ICD_CD","ICD_NM"),
  STROKE_STRICT_ALL_DXS%>%select("PT_ID","INDEX_DT","ENC_DT","ICD_CD","ICD_NM")
)
############
# ICD codes
###########
icd_AFIB_FLUTTER<-c("427.32",  "I48.3",  "I48.4",  "I48.92",  "427.3",  "427.31",
                    "I48",  "I48.0",  "I48.1",  "I48.11",  "I48.19",  "I48.2",
                    "I48.20",  "I48.21",  "I48.9",  "I48.91")
icd_PREECLAMPSIA<-c("O11.1", "O11.2",  "O11.3",	"O11.9",	"O13.1",	"O13.2",	
                    "O13.3",	"O13.9",	"O14.0",	"O14.2",	"O14.9",	"O15.O",
                    "O15.1",	"O15.2",	"O15.9",	"O16.1",	"O16.2",	"O16.3",
                    "O16.9",	"642.3",	"642.9",	"642.4",	"642.5",	"642.6",
                    "642.7")
icd_CERVICOCEPHALIC<-c("443.24", "443.21", "I77.74", "I57.0", "I77.71")
icd_CEREBRAL_AMYLOID<-c("I68.0")
icd_MOYAMOYA<-c("437.5", "I67.5")
icd_FIBROMUSCULAR<-c("447.8", "I77.3")
icd_CEREBRAL_VASOCONSTRICTION<-c("435.9", "I67.841")
icd_SUSAC_SYNDROME<-c("348.39", "G93.49")
icd_SNEDDON_SYNDROME<-c("I77.8")
icd_SICKLE_CELL<-c("282.41",	"282.42",	"282.6",	"282.61",	"282.62",	"282.63",	
                   "282.64",	"282.68",	"289.52",	"D57.00",	"D57.02",	"D57.1",
                   "D57.20",	"D57.211",	"D57.212",	"D57.219", "D57.40",	
                   "D57.419",	"D57.80",	"D57.819")
icd_FABRY_DISEASE<-c("272.7", "E75.21")
icd_CADASIL<-c("I67.850")
icd_MELAS<-c("277.87",  "E88.41")
icd_MARFAN_SYNDROME<-c("759.82", "Q87.40",	"Q87.410",	"Q87.418",	"Q87.42",
                       "Q87.43")
icd_NEUROFIBROMATOSIS<-c("237.7",	"237.71",	"237.72",	"237.79",	"Q85.00",	
                         "Q85.01",	"Q85.02",	"Q85.09")
icd_STURGE_WEBER_DISEASE<-c("759.6", "Q85.8")
icd_VASCULITIS<-c("437.4",	"710.2",	"446.4",	"I67.7")
icd_TEMPORAL_ARTERITIS<-c("446.5", "M31.6", "M31.5")
icd_TAKAYASU_DISEASE<-c("446.7", "M31.4")
icd_BEHCET_SYNDROME<-c("136.1", "711.20", "M35.2")
icd_NEUROSARCOIDOSIS<-c("135", "341.9", "D86.81", "D86.89", "G37.9")
icd_HIV<-c("042", "V08", "795.71", "B20")
icd_VARICELLA_ZOSTER_VIRUS<-c("052.7",	"052.8",	"052.9",	"053.2",	"053.29",
                              "053.71", "053.79",	"053.8",	"B01.89",	"B01.9",
                              "B02.39", "B02.8")
icd_NEUROSYPHILIS<-c("090.4",	"090.49",	"091",	"094",	"094.1",	"094.2",	
                     "094.3",	"094.8",	"094.83",	"094.84",	"094.89",	"094.9",
                     "095.8",	"A50.4",	"A50.41",	"A50.42",	"A50.43",	"A50.44",
                     "A50.45",	"A50.49",	"A52.04",	"A52.05","A52.1",	"A52.11",
                     "A52.12",	"A52.13",	"A52.14", "A52.15",	"A52.16",	"A52.17",
                     "A52.19",	"A52.2", "A52.3")
icd_TB_MENINGITIS<-c("013.00",	"013.01",	"013.02",	"013.03",	"013.04",	"013.05",	
                     "013.06",	"A17.0",	"A17.1",	"A17.81",	"A17.82",	
                     "A17.9")
icd_HYPERCOAG<-c("289.81", "289.82", "D68.5", "D68.51", "D68.52", "D68.59",
                 "D68.6", "D68.61", "D68.62", "D68.69")
icd_RHEUM<-c(
  "710",     "710.0",   "710.1",   "710.2",   "710.3",   "710.4",   "710.5",   "710.8",   "710.9",   "714",     "714.0",   "714.1",   "714.2",   "714.4",  
  "714.8",   "714.81",  "714.89",  "714.9",   "725",     "M05",     "M05.0",   "M05.00",  "M05.01",  "M05.011", "M05.012", "M05.019", "M05.02",  "M05.021",
  "M05.022",  "M05.029", "M05.03",  "M05.031", "M05.032", "M05.039", "M05.04",  "M05.041", "M05.042", "M05.049", "M05.05",  "M05.051", "M05.052", "M05.059",
  "M05.06",   "M05.061", "M05.062", "M05.069", "M05.07",  "M05.071", "M05.072", "M05.079", "M05.09",  "M05.1",   "M05.10",  "M05.11",  "M05.111", "M05.112",
  "M05.119",  "M05.12",  "M05.121", "M05.122", "M05.129", "M05.13",  "M05.131", "M05.132", "M05.139", "M05.14",  "M05.141", "M05.142", "M05.149", "M05.15", 
  "M05.151",  "M05.152",  "M05.159",  "M05.16",  "M05.161", "M05.162", "M05.169", "M05.17",  "M05.171", "M05.172", "M05.179", "M05.19",  "M05.2",   "M05.20", 
  "M05.21",   "M05.211", "M05.212", "M05.219", "M05.22",  "M05.221", "M05.222", "M05.229", "M05.23",  "M05.231", "M05.232", "M05.239", "M05.24",  "M05.241",
  "M05.242", "M05.249", "M05.25",  "M05.251", "M05.252", "M05.259", "M05.26",  "M05.261", "M05.262", "M05.269", "M05.27",  "M05.271", "M05.272", "M05.279",
  "M05.29",  "M05.3",   "M05.30",  "M05.31",  "M05.311", "M05.312", "M05.319", "M05.32",  "M05.321", "M05.322", "M05.329", "M05.33",  "M05.331", "M05.332",
  "M05.339", "M05.34",  "M05.341", "M05.342", "M05.349", "M05.35",  "M05.351", "M05.352", "M05.359", "M05.36",  "M05.361", "M05.362", "M05.369", "M05.37", 
  "M05.371", "M05.372", "M05.379", "M05.39",  "M05.4",   "M05.40",  "M05.41",  "M05.411", "M05.412", "M05.419", "M05.42",  "M05.421", "M05.422", "M05.429",
  "M05.43",  "M05.431", "M05.432", "M05.439", "M05.44",  "M05.441", "M05.442", "M05.449", "M05.45",  "M05.451", "M05.452", "M05.459", "M05.46",  "M05.461",
  "M05.462", "M05.469", "M05.47",  "M05.471", "M05.472", "M05.479", "M05.49",  "M05.5",   "M05.50",  "M05.51",  "M05.511", "M05.512", "M05.519", "M05.52", 
  "M05.521", "M05.522", "M05.529", "M05.53",  "M05.531", "M05.532", "M05.539", "M05.54",  "M05.541", "M05.542", "M05.549", "M05.55",  "M05.551", "M05.552",
  "M05.559", "M05.56",  "M05.561", "M05.562", "M05.569", "M05.57",  "M05.571", "M05.572", "M05.579", "M05.59",  "M05.6",   "M05.60",  "M05.61",  "M05.611",
  "M05.612", "M05.619", "M05.62",  "M05.621", "M05.622", "M05.629", "M05.63",  "M05.631", "M05.632", "M05.639", "M05.64",  "M05.641", "M05.642", "M05.649",
  "M05.65",  "M05.651", "M05.652", "M05.659", "M05.66",  "M05.661", "M05.662", "M05.669", "M05.67",  "M05.671", "M05.672", "M05.679", "M05.69",  "M05.7",  
  "M05.70",  "M05.71",  "M05.711", "M05.712", "M05.719", "M05.72",  "M05.721", "M05.722", "M05.729", "M05.73",  "M05.731", "M05.732", "M05.739", "M05.74", 
  "M05.741", "M05.742", "M05.749", "M05.75",  "M05.751", "M05.752", "M05.759", "M05.76",  "M05.761", "M05.762", "M05.769", "M05.77",  "M05.771", "M05.772",
  "M05.779", "M05.79",  "M05.8",   "M05.80",  "M05.81",  "M05.811", "M05.812", "M05.819", "M05.82",  "M05.821", "M05.822", "M05.829", "M05.83",  "M05.831",
  "M05.832", "M05.839", "M05.84",  "M05.841", "M05.842", "M05.849", "M05.85",  "M05.851", "M05.852", "M05.859", "M05.86",  "M05.861", "M05.862", "M05.869",
  "M05.87",  "M05.871", "M05.872", "M05.879", "M05.89",  "M05.9",   "M06",     "M06.0",   "M06.00",  "M06.01",  "M06.011", "M06.012", "M06.019", "M06.02", 
  "M06.021", "M06.022", "M06.029", "M06.03",  "M06.031", "M06.032", "M06.039", "M06.04",  "M06.041", "M06.042", "M06.049", "M06.05",  "M06.051", "M06.052",
  "M06.059", "M06.06",  "M06.061", "M06.062", "M06.069", "M06.07",  "M06.071", "M06.072", "M06.079", "M06.08",  "M06.09",  "M06.1",   "M06.2",   "M06.20", 
  "M06.21",  "M06.211", "M06.212", "M06.219", "M06.22",  "M06.221", "M06.222", "M06.229", "M06.23",  "M06.231", "M06.232", "M06.239", "M06.24",  "M06.241",
  "M06.242", "M06.249", "M06.25",  "M06.251", "M06.252", "M06.259", "M06.26",  "M06.261", "M06.262", "M06.269", "M06.27",  "M06.271", "M06.272", "M06.279",
  "M06.28",  "M06.29",  "M06.3",   "M06.30",  "M06.31",  "M06.311", "M06.312", "M06.319", "M06.32",  "M06.321", "M06.322", "M06.329", "M06.33",  "M06.331",
  "M06.332", "M06.339", "M06.34",  "M06.341", "M06.342", "M06.349", "M06.35",  "M06.351", "M06.352", "M06.359", "M06.36",  "M06.361", "M06.362", "M06.369",
  "M06.37",  "M06.371", "M06.372", "M06.379", "M06.38",  "M06.39",  "M06.4",   "M06.8",   "M06.80",  "M06.81",  "M06.811", "M06.812", "M06.819", "M06.82", 
  "M06.821", "M06.822", "M06.829", "M06.83",  "M06.831", "M06.832", "M06.839", "M06.84",  "M06.841", "M06.842", "M06.849", "M06.85",  "M06.851", "M06.852",
  "M06.859", "M06.86",  "M06.861", "M06.862", "M06.869", "M06.87",  "M06.871", "M06.872", "M06.879", "M06.88",  "M06.89",  "M06.9",   "M31.5",   "M32",    
  "M32.0",   "M32.1",   "M32.10",  "M32.11",  "M32.12",  "M32.13",  "M32.14",  "M32.15",  "M32.19",  "M32.8",   "M32.9",   "M33",     "M33.0",   "M33.00", 
  "M33.01",  "M33.02",  "M33.03",  "M33.09",  "M33.1",   "M33.10",  "M33.11",  "M33.12",  "M33.13",  "M33.19",  "M33.2",   "M33.20",  "M33.21",  "M33.22", 
  "M33.29",  "M33.9",   "M33.90",  "M33.91",  "M33.92",  "M33.93",  "M33.99",  "M34",     "M34.0",   "M34.1",   "M34.2",   "M34.8",   "M34.81",  "M34.82", 
  "M34.83",  "M34.89",  "M34.9",   "M35.1",   "M35.3",   "M36.0"
)
icd_CIRRHOSIS<-c("571.2","571.5","571.6","K74","K74.0","K74.1","K74.2","K74.3",
                 "K74.4","K74.5","K74.6","K74.60","K74.69")
icd_NEOPLASM<-c(
  "140.0",	"140.1",	"140.4",	"140.5",	"140.6",	"140.8",	"140.9",	"141.0",	"141.1",	"141.2",	"141.3",	"141.4",	"141.5",	"141.6",	"141.8",	"141.9",	
  "142.0",	"142.1",	"142.2",	"142.8",	"142.9",	"143.0",	"143.1",	"143.8",	"143.9",	"144.0",	"144.1",	"144.8",	"144.9",	"145.0",	"145.1",	"145.2",	
  "145.3",	"145.4",	"145.5",	"145.6",	"145.8",	"145.9",	"146.0",	"146.1",	"146.2",	"146.3",	"146.4",	"146.5",	"146.6",	"146.7",	"146.8",	"146.9",	
  "147.0",	"147.1",	"147.2",	"147.3",	"147.8",	"147.9",	"148.0",	"148.1",	"148.2",	"148.3",	"148.8",	"148.9",	"149.0",	"149.8",	"149.9",	"150.0",	
  "150.1",	"150.2",	"150.3",	"150.4",	"150.5",	"150.8",	"150.9",	"151.0",	"151.1",	"151.2",	"151.3",	"151.4",	"151.5",	"151.6",	"151.8",	"151.9",	
  "152.0",	"152.1",	"152.2",	"152.3",	"152.8",	"152.9",	"153",	"153.0",	"153.1",	"153.2",	"153.3",	"153.4",	"153.5",	"153.6",	"153.7",	"153.8",	
  "153.9",	"154",	"154.0",	"154.1",	"154.2",	"154.3",	"154.8",	"155.0",	"155.1",	"155.2",	"156.0",	"156.1",	"156.2",	"156.8",	"156.9",	"157",	
  "157.0",	"157.1",	"157.2",	"157.3",	"157.4",	"157.8",	"157.9",	"158",	"158.0",	"158.8",	"158.9",	"159",	"159.0",	"159.1",	"159.8",	"159.9",	
  "160.0",	"160.1",	"160.2",	"160.3",	"160.4",	"160.5",	"160.9",	"161.0",	"161.1",	"161.2",	"161.3",	"161.8",	"161.9",	"162",	"162.0",	"162.2",	
  "162.3",	"162.4",	"162.5",	"162.8",	"162.9",	"163.0",	"163.1",	"163.8",	"163.9",	"164.0",	"164.1",	"164.2",	"164.3",	"164.8",	"164.9",	"165.8",	
  "165.9",	"170.0",	"170.1",	"170.2",	"170.3",	"170.4",	"170.5",	"170.6",	"170.7",	"170.8",	"170.9",	"171.0",	"171.2",	"171.3",	"171.4",	"171.5",	
  "171.6",	"171.7",	"171.8",	"171.9",	"172.0",	"172.1",	"172.2",	"172.3",	"172.4",	"172.5",	"172.6",	"172.7",	"172.8",	"172.9",	"173.0",	"173.00",	
  "173.01",	"173.02",	"173.09",	"173.1",	"173.10",	"173.11",	"173.12",	"173.19",	"173.2",	"173.20",	"173.21",	"173.22",	"173.29",	"173.3",	"173.30",	"173.31",	
  "173.32",	"173.39",	"173.4",	"173.40",	"173.41",	"173.42",	"173.49",	"173.5",	"173.50",	"173.51",	"173.52",	"173.59",	"173.6",	"173.60",	"173.61",	"173.62",	
  "173.69",	"173.7",	"173.70",	"173.71",	"173.72",	"173.79",	"173.8",	"173.80",	"173.81",	"173.82",	"173.89",	"173.9",	"173.90",	"173.91",	"173.92",	"173.99",	
  "174",	"174.0",	"174.1",	"174.2",	"174.3",	"174.4",	"174.5",	"174.6",	"174.8",	"174.9",	"175.0",	"175.9",	"176.0",	"176.1",	"176.2",	"176.3",	
  "176.4",	"176.8",	"176.9",	"179",	"180.0",	"180.1",	"180.8",	"180.9",	"181",	"182.0",	"182.1",	"182.8",	"183",	"183.0",	"183.2",	"183.4",	"183.5",	
  "183.8",	"183.9",	"184.0",	"184.1",	"184.2",	"184.3",	"184.4",	"184.8",	"184.9",	"185",	"186.0",	"186.9",	"187.1",	"187.2",	"187.3",	"187.4",	
  "187.6",	"187.7",	"187.8",	"187.9",	"188.0",	"188.1",	"188.2",	"188.3",	"188.4",	"188.5",	"188.6",	"188.7",	"188.8",	"188.9",	"189.0",	"189.1",	
  "189.2",	"189.3",	"189.4",	"189.8",	"189.9",	"190.0",	"190.1",	"190.2",	"190.3",	"190.4",	"190.5",	"190.6",	"190.7",	"190.8",	"190.9",	"191.0",	
  "191.1",	"191.2",	"191.3",	"191.4",	"191.5",	"191.6",	"191.7",	"191.8",	"191.9",	"192.0",	"192.1",	"192.2",	"192.3",	"192.8",	"192.9",	"193",	
  "194.0",	"194.1",	"194.3",	"194.4",	"194.5",	"194.6",	"194.8",	"194.9",	"195.0",	"195.1",	"195.2",	"195.3",	"195.4",	"195.5",	"195.8",	"196.0",	
  "196.1",	"196.2",	"196.3",	"196.5",	"196.6",	"196.8",	"196.9",	"197.0",	"197.1",	"197.2",	"197.3",	"197.4",	"197.5",	"197.6",	"197.7",	"197.8",	
  "198.0",	"198.1",	"198.2",	"198.3",	"198.4",	"198.5",	"198.6",	"198.7",	"198.81",	"198.82",	"198.89",	"199",	"199.0",	"199.1",	"199.2",	"200",	
  "200.00",	"200.01",	"200.02",	"200.03",	"200.04",	"200.05",	"200.06",	"200.08",	"200.10",	"200.11",	"200.12",	"200.13",	"200.14",	"200.15",	"200.16",	"200.18",	
  "200.20",	"200.21",	"200.22",	"200.23",	"200.24",	"200.27",	"200.28",	"200.30",	"200.31",	"200.32",	"200.33",	"200.34",	"200.35",	"200.37",	"200.38",	"200.40",	
  "200.41",	"200.42",	"200.43",	"200.44",	"200.45",	"200.47",	"200.48",	"200.50",	"200.51",	"200.53",	"200.57",	"200.58",	"200.60",	"200.61",	"200.62",	"200.63",	
  "200.64",	"200.65",	"200.68",	"200.70",	"200.71",	"200.72",	"200.73",	"200.74",	"200.75",	"200.77",	"200.78",	"200.8",	"200.80",	"200.81",	"200.82",	"200.83",	
  "200.88",	"201.00",	"201.01",	"201.10",	"201.12",	"201.20",	"201.21",	"201.25",	"201.26",	"201.40",	"201.42",	"201.43",	"201.44",	"201.45",	"201.47",	"201.48",	
  "201.50",	"201.51",	"201.52",	"201.53",	"201.54",	"201.58",	"201.60",	"201.61",	"201.63",	"201.64",	"201.68",	"201.70",	"201.71",	"201.72",	"201.73",	"201.74",	
  "201.75",	"201.78",	"201.9",	"201.90",	"201.91",	"201.92",	"201.93",	"201.94",	"201.95",	"201.96",	"201.97",	"201.98",	"202.00",	"202.01",	"202.02",	"202.03",	
  "202.04",	"202.05",	"202.06",	"202.07",	"202.08",	"202.10",	"202.11",	"202.12",	"202.13",	"202.14",	"202.15",	"202.16",	"202.17",	"202.18",	"202.20",	"202.21",	
  "202.28",	"202.30",	"202.31",	"202.32",	"202.33",	"202.34",	"202.36",	"202.38",	"202.40",	"202.42",	"202.43",	"202.44",	"202.47",	"202.48",	"202.50",	"202.51",	
  "202.58",	"202.60",	"202.62",	"202.63",	"202.68",	"202.70",	"202.72",	"202.73",	"202.74",	"202.75",	"202.77",	"202.78",	"202.8",	"202.80",	"202.81",	"202.82",	
  "202.83",	"202.84",	"202.85",	"202.86",	"202.87",	"202.88",	"202.90",	"202.91",	"202.92",	"202.93",	"202.94",	"202.95",	"202.96",	"202.97",	"202.98",	"203",	
  "203.0",	"203.00",	"203.01",	"203.02",	"203.10",	"203.11",	"203.80",	"204.00",	"204.01",	"204.02",	"204.1",	"204.10",	"204.11",	"204.12",	"204.80",	"204.81",	
  "204.90",	"204.91",	"204.92",	"205.00",	"205.01",	"205.02",	"205.1",	"205.10",	"205.11",	"205.12",	"205.30",	"205.31",	"205.80",	"205.81",	"205.90",	"205.91",	
  "206.00",	"206.01",	"206.02",	"206.10",	"206.80",	"206.81",	"206.90",	"207.20",	"207.21",	"207.80",	"207.81",	"208.0",	"208.00",	"208.01",	"208.02",	"208.1",	
  "208.10",	"208.11",	"208.20",	"208.21",	"208.80",	"208.81",	"208.90",	"208.91",	"208.92",	"209.00",	"209.01",	"209.02",	"209.03",	"209.10",	"209.11",	"209.12",	
  "209.13",	"209.16",	"209.17",	"209.20",	"209.21",	"209.22",	"209.23",	"209.24",	"209.25",	"209.26",	"209.27",	"209.29",	"209.30",	"209.31",	"209.32",	"209.33",	
  "209.34",	"209.35",	"209.36",	"209.40",	"209.41",	"209.43",	"209.50",	"209.51",	"209.52",	"209.53",	"209.55",	"209.56",	"209.57",	"209.60",	"209.61",	"209.63",	
  "209.64",	"209.65",	"209.66",	"209.69",	"209.70",	"209.71",	"209.72",	"209.73",	"209.74",	"209.75",	"209.79",	"C00",	"C00.0",	"C00.1",	"C00.2",	"C00.3",	
  "C00.4",	"C00.5",	"C00.6",	"C00.8",	"C00.9",	"C01",	"C02",	"C02.0",	"C02.1",	"C02.2",	"C02.3",	"C02.4",	"C02.8",	"C02.9",	"C03",	"C03.0",	"C03.1",	
  "C03.9",	"C04",	"C04.0",	"C04.1",	"C04.8",	"C04.9",	"C05",	"C05.0",	"C05.1",	"C05.2",	"C05.8",	"C05.9",	"C06",	"C06.0",	"C06.1",	"C06.2",	"C06.8",	
  "C06.80",	"C06.89",	"C06.9",	"C07",	"C08",	"C08.0",	"C08.1",	"C08.9",	"C09",	"C09.0",	"C09.1",	"C09.8",	"C09.9",	"C10",	"C10.0",	"C10.1",	"C10.2",	
  "C10.3",	"C10.4",	"C10.8",	"C10.9",	"C11",	"C11.0",	"C11.1",	"C11.2",	"C11.3",	"C11.8",	"C11.9",	"C12",	"C13",	"C13.0",	"C13.1",	"C13.2",	"C13.8",	
  "C13.9",	"C14",	"C14.0",	"C14.2",	"C14.8",	"C15",	"C15.3",	"C15.4",	"C15.5",	"C15.8",	"C15.9",	"C16",	"C16.0",	"C16.1",	"C16.2",	"C16.3",	"C16.4",	
  "C16.5",	"C16.6",	"C16.8",	"C16.9",	"C17",	"C17.0",	"C17.1",	"C17.2",	"C17.3",	"C17.8",	"C17.9",	"C18",	"C18.0",	"C18.1",	"C18.2",	"C18.3",	"C18.4",	
  "C18.5",	"C18.6",	"C18.7",	"C18.8",	"C18.9",	"C19",	"C20",	"C21",	"C21.0",	"C21.1",	"C21.2",	"C21.8",	"C22",	"C22.0",	"C22.1",	"C22.2",	"C22.3",	
  "C22.4",	"C22.7",	"C22.8",	"C22.9",	"C23",	"C24",	"C24.0",	"C24.1",	"C24.8",	"C24.9",	"C25",	"C25.0",	"C25.1",	"C25.2",	"C25.3",	"C25.4",	"C25.7",	
  "C25.8",	"C25.9",	"C26",	"C26.0",	"C26.1",	"C26.9",	"C30",	"C30.0",	"C30.1",	"C31",	"C31.0",	"C31.1",	"C31.2",	"C31.3",	"C31.8",	"C31.9",	"C32",	
  "C32.0",	"C32.1",	"C32.2",	"C32.3",	"C32.8",	"C32.9",	"C33",	"C34",	"C34.0",	"C34.00",	"C34.01",	"C34.02",	"C34.1",	"C34.10",	"C34.11",	"C34.12",	"C34.2",	
  "C34.3",	"C34.30",	"C34.31",	"C34.32",	"C34.8",	"C34.80",	"C34.81",	"C34.82",	"C34.9",	"C34.90",	"C34.91",	"C34.92",	"C37",	"C38",	"C38.0",	"C38.1",	"C38.2",	
  "C38.3",	"C38.4",	"C38.8",	"C39",	"C39.0",	"C39.9",	"C40",	"C40.0",	"C40.00",	"C40.01",	"C40.02",	"C40.1",	"C40.10",	"C40.11",	"C40.12",	"C40.2",	"C40.20",	
  "C40.21",	"C40.22",	"C40.3",	"C40.30",	"C40.31",	"C40.32",	"C40.8",	"C40.80",	"C40.81",	"C40.82",	"C40.9",	"C40.90",	"C40.91",	"C40.92",	"C41",	"C41.0",	"C41.1",	
  "C41.2",	"C41.3",	"C41.4",	"C41.9",	"C43",	"C43.0",	"C43.1",	"C43.10",	"C43.11",	"C43.12",	"C43.2",	"C43.20",	"C43.21",	"C43.22",	"C43.3",	"C43.30",	"C43.31",	
  "C43.39",	"C43.4",	"C43.5",	"C43.51",	"C43.52",	"C43.59",	"C43.6",	"C43.60",	"C43.61",	"C43.62",	"C43.7",	"C43.70",	"C43.71",	"C43.72",	"C43.8",	"C43.9",	"C45",	
  "C45.0",	"C45.1",	"C45.2",	"C45.7",	"C45.9",	"C46",	"C46.0",	"C46.1",	"C46.2",	"C46.3",	"C46.4",	"C46.5",	"C46.50",	"C46.51",	"C46.52",	"C46.7",	"C46.9",	
  "C47",	"C47.0",	"C47.1",	"C47.10",	"C47.11",	"C47.12",	"C47.2",	"C47.20",	"C47.21",	"C47.22",	"C47.3",	"C47.4",	"C47.5",	"C47.6",	"C47.8",	"C47.9",	"C48",	
  "C48.0",	"C48.1",	"C48.2",	"C48.8",	"C49",	"C49.0",	"C49.1",	"C49.10",	"C49.11",	"C49.12",	"C49.2",	"C49.20",	"C49.21",	"C49.22",	"C49.3",	"C49.4",	"C49.5",	
  "C49.6",	"C49.8",	"C49.9",	"C49.A",	"C49.A0",	"C49.A1",	"C49.A2",	"C49.A3",	"C49.A4",	"C49.A5",	"C49.A9",	"C4A",	"C4A.0",	"C4A.1",	"C4A.10",	"C4A.11",	"C4A.12",	
  "C4A.2",	"C4A.20",	"C4A.21",	"C4A.22",	"C4A.3",	"C4A.30",	"C4A.31",	"C4A.39",	"C4A.4",	"C4A.5",	"C4A.51",	"C4A.52",	"C4A.59",	"C4A.6",	"C4A.60",	"C4A.61",	"C4A.62",
  "C4A.7",	"C4A.70",	"C4A.71",	"C4A.72",	"C4A.8",	"C4A.9",	"C50",	"C50.0",	"C50.01",	"C50.011",	"C50.012",	"C50.019",	"C50.02",	"C50.021",	"C50.022",	"C50.029",	
  "C50.1",	"C50.11",	"C50.111",	"C50.112",	"C50.119",	"C50.12",	"C50.121",	"C50.122",	"C50.129",	"C50.2",	"C50.21",	"C50.211",	"C50.212",	"C50.219",	"C50.22",	
  "C50.221",	"C50.222",	"C50.229",	"C50.3",	"C50.31",	"C50.311",	"C50.312",	"C50.319",	"C50.32",	"C50.321",	"C50.322",	"C50.329",	"C50.4",	"C50.41",	"C50.411",
  "C50.412",	"C50.419",	"C50.42",	"C50.421",	"C50.422",	"C50.429",	"C50.5",	"C50.51",	"C50.511",	"C50.512",	"C50.519",	"C50.52",	"C50.521",	"C50.522",	"C50.529",
  "C50.6",	"C50.61",	"C50.611",	"C50.612",	"C50.619",	"C50.62",	"C50.621",	"C50.622",	"C50.629",	"C50.8",	"C50.81",	"C50.811",	"C50.812",	"C50.819",	"C50.82",
  "C50.821",	"C50.822",	"C50.829",	"C50.9",	"C50.91",	"C50.911",	"C50.912",	"C50.919",	"C50.92",	"C50.921",	"C50.922",	"C50.929",	"C51",	"C51.0",	"C51.1",
  "C51.2",	"C51.8",	"C51.9",	"C52",	"C53",	"C53.0",	"C53.1",	"C53.8",	"C53.9",	"C54",	"C54.0",	"C54.1",	"C54.2",	"C54.3",	"C54.8",	"C54.9",	"C55",	"C56",
  "C56.1",	"C56.2",	"C56.9",	"C57",	"C57.0",	"C57.00",	"C57.01",	"C57.02",	"C57.1",	"C57.10",	"C57.11",	"C57.12",	"C57.2",	"C57.20",	"C57.21",	"C57.22",	"C57.3",
  "C57.4",	"C57.7",	"C57.8",	"C57.9",	"C58",	"C60",	"C60.0",	"C60.1",	"C60.2",	"C60.8",	"C60.9",	"C61",	"C62",	"C62.0",	"C62.00",	"C62.01",	"C62.02",	"C62.1",
  "C62.10",	"C62.11",	"C62.12",	"C62.9",	"C62.90",	"C62.91",	"C62.92",	"C63",	"C63.0",	"C63.00",	"C63.01",	"C63.02",	"C63.1",	"C63.10",	"C63.11",	"C63.12",	"C63.2",
  "C63.7",	"C63.8",	"C63.9",	"C64",	"C64.1",	"C64.2",	"C64.9",	"C65",	"C65.1",	"C65.2",	"C65.9",	"C66",	"C66.1",	"C66.2",	"C66.9",	"C67",	"C67.0",
  "C67.1",	"C67.2",	"C67.3",	"C67.4",	"C67.5",	"C67.6",	"C67.7",	"C67.8",	"C67.9",	"C68",	"C68.0",	"C68.1",	"C68.8",	"C68.9",	"C69",	"C69.0",	"C69.00",
  "C69.01",	"C69.02",	"C69.1",	"C69.10",	"C69.11",	"C69.12",	"C69.2",	"C69.20",	"C69.21",	"C69.22",	"C69.3",	"C69.30",	"C69.31",	"C69.32",	"C69.4",	"C69.40",	"C69.41",
  "C69.42",	"C69.5",	"C69.50",	"C69.51",	"C69.52",	"C69.6",	"C69.60",	"C69.61",	"C69.62",	"C69.8",	"C69.80",	"C69.81",	"C69.82",	"C69.9",	"C69.90",	"C69.91",	"C69.92",
  "C70",	"C70.0",	"C70.1",	"C70.9",	"C71",	"C71.0",	"C71.1",	"C71.2",	"C71.3",	"C71.4",	"C71.5",	"C71.6",	"C71.7",	"C71.8",	"C71.9",	"C72",	"C72.0",
  "C72.1",	"C72.2",	"C72.20",	"C72.21",	"C72.22",	"C72.3",	"C72.30",	"C72.31",	"C72.32",	"C72.4",	"C72.40",	"C72.41",	"C72.42",	"C72.5",	"C72.50",	"C72.59",	"C72.9",
  "C73",	"C74",	"C74.0",	"C74.00",	"C74.01",	"C74.02",	"C74.1",	"C74.10",	"C74.11",	"C74.12",	"C74.9",	"C74.90",	"C74.91",	"C74.92",	"C75",	"C75.0",	"C75.1",	
  "C75.2",	"C75.3",	"C75.4",	"C75.5",	"C75.8",	"C75.9",	"C76",	"C76.0",	"C76.1",	"C76.2",	"C76.3",	"C76.4",	"C76.40",	"C76.41",	"C76.42",	"C76.5",	"C76.50",	
  "C76.51",	"C76.52",	"C76.8",	"C77",	"C77.0",	"C77.1",	"C77.2",	"C77.3",	"C77.4",	"C77.5",	"C77.8",	"C77.9",	"C78",	"C78.0",	"C78.00",	"C78.01",	"C78.02",	
  "C78.1",	"C78.2",	"C78.3",	"C78.30",	"C78.39",	"C78.4",	"C78.5",	"C78.6",	"C78.7",	"C78.8",	"C78.80",	"C78.89",	"C79",	"C79.0",	"C79.00",	"C79.01",	"C79.02",
  "C79.1",	"C79.10",	"C79.11",	"C79.19",	"C79.2",	"C79.3",	"C79.31",	"C79.32",	"C79.4",	"C79.40",	"C79.49",	"C79.5",	"C79.51",	"C79.52",	"C79.6",	"C79.60",	"C79.61",	
  "C79.62",	"C79.7",	"C79.70",	"C79.71",	"C79.72",	"C79.8",	"C79.81",	"C79.82",	"C79.89",	"C79.9",	"C7A",	"C7A.0",	"C7A.00",	"C7A.01",	"C7A.010",	"C7A.011",	"C7A.012",
  "C7A.019",	"C7A.02",	"C7A.020",	"C7A.021",	"C7A.022",	"C7A.023",	"C7A.024",	"C7A.025",	"C7A.026",	"C7A.029",	"C7A.09",	"C7A.090",	"C7A.091",	"C7A.092",	"C7A.093",
  "C7A.094",	"C7A.095",	"C7A.096",	"C7A.098",	"C7A.1",	"C7A.8",	"C7B",	"C7B.0",	"C7B.00",	"C7B.01",	"C7B.02",	"C7B.03",	"C7B.04",	"C7B.09",	"C7B.1",	"C7B.8",	"C80",
  "C80.0",	"C80.1",	"C80.2",	"C81",	"C81.0",	"C81.00",	"C81.01",	"C81.02",	"C81.03",	"C81.04",	"C81.05",	"C81.06",	"C81.07",	"C81.08",	"C81.09",	"C81.1",	"C81.10",	
  "C81.11",	"C81.12",	"C81.13",	"C81.14",	"C81.15",	"C81.16",	"C81.17",	"C81.18",	"C81.19",	"C81.2",	"C81.20",	"C81.21",	"C81.22",	"C81.23",	"C81.24",	"C81.25",	"C81.26",
  "C81.27",	"C81.28",	"C81.29",	"C81.3",	"C81.30",	"C81.31",	"C81.32",	"C81.33",	"C81.34",	"C81.35",	"C81.36",	"C81.37",	"C81.38",	"C81.39",	"C81.4",	"C81.40",	"C81.41",
  "C81.42",	"C81.43",	"C81.44",	"C81.45",	"C81.46",	"C81.47",	"C81.48",	"C81.49",	"C81.7",	"C81.70",	"C81.71",	"C81.72",	"C81.73",	"C81.74",	"C81.75",	"C81.76",	"C81.77",
  "C81.78",	"C81.79",	"C81.9",	"C81.90",	"C81.91",	"C81.92",	"C81.93",	"C81.94",	"C81.95",	"C81.96",	"C81.97",	"C81.98",	"C81.99",	"C82",	"C82.0",	"C82.00",	"C82.01",	
  "C82.02",	"C82.03",	"C82.04",	"C82.05",	"C82.06",	"C82.07",	"C82.08",	"C82.09",	"C82.1",	"C82.10",	"C82.11",	"C82.12",	"C82.13",	"C82.14",	"C82.15",	"C82.16",	"C82.17",
  "C82.18",	"C82.19",	"C82.2",	"C82.20",	"C82.21",	"C82.22",	"C82.23",	"C82.24",	"C82.25",	"C82.26",	"C82.27",	"C82.28",	"C82.29",	"C82.3",	"C82.30",	"C82.31",	"C82.32",
  "C82.33",	"C82.34",	"C82.35",	"C82.36",	"C82.37",	"C82.38",	"C82.39",	"C82.4",	"C82.40",	"C82.41",	"C82.42",	"C82.43",	"C82.44",	"C82.45",	"C82.46",	"C82.47",	"C82.48",
  "C82.49",	"C82.5",	"C82.50",	"C82.51",	"C82.52",	"C82.53",	"C82.54",	"C82.55",	"C82.56",	"C82.57",	"C82.58",	"C82.59",	"C82.6",	"C82.60",	"C82.61",	"C82.62",	"C82.63",	
  "C82.64",	"C82.65",	"C82.66",	"C82.67",	"C82.68",	"C82.69",	"C82.8",	"C82.80",	"C82.81",	"C82.82",	"C82.83",	"C82.84",	"C82.85",	"C82.86",	"C82.87",	"C82.88",	"C82.89",	
  "C82.9",	"C82.90",	"C82.91",	"C82.92",	"C82.93",	"C82.94",	"C82.95",	"C82.96",	"C82.97",	"C82.98",	"C82.99",	"C83",	"C83.0",	"C83.00",	"C83.01",	"C83.02",	"C83.03",	
  "C83.04",	"C83.05",	"C83.06",	"C83.07",	"C83.08",	"C83.09",	"C83.1",	"C83.10",	"C83.11",	"C83.12",	"C83.13",	"C83.14",	"C83.15",	"C83.16",	"C83.17",	"C83.18",	"C83.19",	
  "C83.3",	"C83.30",	"C83.31",	"C83.32",	"C83.33",	"C83.34",	"C83.35",	"C83.36",	"C83.37",	"C83.38",	"C83.39",	"C83.5",	"C83.50",	"C83.51",	"C83.52",	"C83.53",	"C83.54",	
  "C83.55",	"C83.56",	"C83.57",	"C83.58",	"C83.59",	"C83.7",	"C83.70",	"C83.71",	"C83.72",	"C83.73",	"C83.74",	"C83.75",	"C83.76",	"C83.77",	"C83.78",	"C83.79",	"C83.8",	
  "C83.80",	"C83.81",	"C83.82",	"C83.83",	"C83.84",	"C83.85",	"C83.86",	"C83.87",	"C83.88",	"C83.89",	"C83.9",	"C83.90",	"C83.91",	"C83.92",	"C83.93",	"C83.94",	"C83.95",	
  "C83.96",	"C83.97",	"C83.98",	"C83.99",	"C84",	"C84.0",	"C84.00",	"C84.01",	"C84.02",	"C84.03",	"C84.04",	"C84.05",	"C84.06",	"C84.07",	"C84.08",	"C84.09",	"C84.1",	
  "C84.10",	"C84.11",	"C84.12",	"C84.13",	"C84.14",	"C84.15",	"C84.16",	"C84.17",	"C84.18",	"C84.19",	"C84.4",	"C84.40",	"C84.41",	"C84.42",	"C84.43",	"C84.44",	"C84.45",
  "C84.46",	"C84.47",	"C84.48",	"C84.49",	"C84.6",	"C84.60",	"C84.61",	"C84.62",	"C84.63",	"C84.64",	"C84.65",	"C84.66",	"C84.67",	"C84.68",	"C84.69",	"C84.7",	"C84.70",	
  "C84.71",	"C84.72",	"C84.73",	"C84.74",	"C84.75",	"C84.76",	"C84.77",	"C84.78",	"C84.79",	"C84.9",	"C84.90",	"C84.91",	"C84.92",	"C84.93",	"C84.94",	"C84.95",	"C84.96",
  "C84.97",	"C84.98",	"C84.99",	"C84.A",	"C84.A0",	"C84.A1",	"C84.A2",	"C84.A3",	"C84.A4",	"C84.A5",	"C84.A6",	"C84.A7",	"C84.A8",	"C84.A9",	"C84.Z",	"C84.Z0",	"C84.Z1",
  "C84.Z2",	"C84.Z3",	"C84.Z4",	"C84.Z5",	"C84.Z6",	"C84.Z7",	"C84.Z8",	"C84.Z9",	"C85",	"C85.1",	"C85.10",	"C85.11",	"C85.12",	"C85.13",	"C85.14",	"C85.15",	"C85.16",	
  "C85.17",	"C85.18",	"C85.19",	"C85.2",	"C85.20",	"C85.21",	"C85.22",	"C85.23",	"C85.24",	"C85.25",	"C85.26",	"C85.27",	"C85.28",	"C85.29",	"C85.8",	"C85.80",	"C85.81",
  "C85.82",	"C85.83",	"C85.84",	"C85.85",	"C85.86",	"C85.87",	"C85.88",	"C85.89",	"C85.9",	"C85.90",	"C85.91",	"C85.92",	"C85.93",	"C85.94",	"C85.95",	"C85.96",	"C85.97",	
  "C85.98",	"C85.99",	"C88",	"C88.0",	"C88.2",	"C88.3",	"C88.4",	"C88.8",	"C88.9",	"C90",	"C90.0",	"C90.00",	"C90.01",	"C90.02",	"C90.1",	"C90.10",	"C90.11",	"C90.12",
  "C90.2",	"C90.20",	"C90.21",	"C90.22",	"C90.3",	"C90.30",	"C90.31",	"C90.32",	"C91",	"C91.0",	"C91.00",	"C91.01",	"C91.02",	"C91.1",	"C91.10",	"C91.11",	"C91.12",	
  "C91.3",	"C91.30",	"C91.31",	"C91.32",	"C91.4",	"C91.40",	"C91.41",	"C91.42",	"C91.5",	"C91.50",	"C91.51",	"C91.52",	"C91.6",	"C91.60",	"C91.61",	"C91.62",	"C91.9",	
  "C91.90",	"C91.91",	"C91.92",	"C91.A",	"C91.A0",	"C91.A1",	"C91.A2",	"C91.Z",	"C91.Z0",	"C91.Z1",	"C91.Z2",	"C92",	"C92.0",	"C92.00",	"C92.01",	"C92.02",	"C92.1",	
  "C92.10",	"C92.11",	"C92.12",	"C92.2",	"C92.20",	"C92.21",	"C92.22",	"C92.3",	"C92.30",	"C92.31",	"C92.32",	"C92.4",	"C92.40",	"C92.41",	"C92.42",	"C92.5",	"C92.50",
  "C92.51",	"C92.52",	"C92.6",	"C92.60",	"C92.61",	"C92.62",	"C92.9",	"C92.90",	"C92.91",	"C92.92",	"C92.A",	"C92.A0",	"C92.A1",	"C92.A2",	"C92.Z",	"C92.Z0",	"C92.Z1",	
  "C92.Z2",	"C93",	"C93.0",	"C93.00",	"C93.01",	"C93.02",	"C93.1",	"C93.10",	"C93.11",	"C93.12",	"C93.3",	"C93.30",	"C93.31",	"C93.32",	"C93.9",	"C93.90",	"C93.91",	
  "C93.92",	"C93.Z",	"C93.Z0",	"C93.Z1",	"C93.Z2",	"C94",	"C94.0",	"C94.00",	"C94.01",	"C94.02",	"C94.2",	"C94.20",	"C94.21",	"C94.22",	"C94.3",	"C94.30",	"C94.31",	
  "C94.32",	"C94.4",	"C94.40",	"C94.41",	"C94.42",	"C94.6",	"C94.8",	"C94.80",	"C94.81",	"C94.82",	"C95",	"C95.0",	"C95.00",	"C95.01",	"C95.02",	"C95.1",	"C95.10",	
  "C95.11",	"C95.12",	"C95.9",	"C95.90",	"C95.91",	"C95.92",	"C96",	"C96.0",	"C96.2",	"C96.4",	"C96.5",	"C96.6",	"C96.9",	"C96.A",	"C96.Z"
)
icd_PERIVASC<-c(
  "440",	"440.0",	"440.1",	"440.2",	"440.20",	"440.21",	"440.22",	"440.23",	"440.24",	"440.29",	"440.3",	"440.30",	"440.31",	"440.32",	"440.4",	"440.8",	"440.9",	
  "441",	"441.0",	"441.00",	"441.01",	"441.02",	"441.03",	"441.1",	"441.2",	"441.3",	"441.4",	"441.5",	"441.6",	"441.7",	"441.9",	"443.0",	"443.1",	"443.8",	
  "443.81",	"443.82",	"443.89",	"443.9",	"447.1",	"557",	"557.0",	"557.1",	"557.9",	"I70",	"I70.0",	"I70.1",	"I70.2",	"I70.20",	"I70.201",	"I70.202",	"I70.203",
  "I70.208",	"I70.209",	"I70.21",	"I70.211",	"I70.212",	"I70.213",	"I70.218",	"I70.219",	"I70.22",	"I70.221",	"I70.222",	"I70.223",	"I70.228",	"I70.229",	
  "I70.23",	"I70.231",	"I70.232",	"I70.233",	"I70.234",	"I70.235",	"I70.238",	"I70.239",	"I70.24",	"I70.241",	"I70.242",	"I70.243",	"I70.244",	"I70.245",	
  "I70.248",	"I70.249",	"I70.25",	"I70.26",	"I70.261",	"I70.262",	"I70.263",	"I70.268",	"I70.269",	"I70.29",	"I70.291",	"I70.292",	"I70.293",	"I70.298",	
  "I70.299",	"I70.3",	"I70.30",	"I70.301",	"I70.302",	"I70.303",	"I70.308",	"I70.309",	"I70.31",	"I70.311",	"I70.312",	"I70.313",	"I70.318",	"I70.319",	
  "I70.32",	"I70.321",	"I70.322",	"I70.323",	"I70.328",	"I70.329",	"I70.33",	"I70.331",	"I70.332",	"I70.333",	"I70.334",	"I70.335",	"I70.338",	"I70.339",	
  "I70.34",	"I70.341",	"I70.342",	"I70.343",	"I70.344",	"I70.345",	"I70.348",	"I70.349",	"I70.35",	"I70.36",	"I70.361",	"I70.362",	"I70.363",	"I70.368",	
  "I70.369",	"I70.39",	"I70.391",	"I70.392",	"I70.393",	"I70.398",	"I70.399",	"I70.4",	"I70.40",	"I70.401",	"I70.402",	"I70.403",	"I70.408",	"I70.409",	
  "I70.41",	"I70.411",	"I70.412",	"I70.413",	"I70.418",	"I70.419",	"I70.42",	"I70.421",	"I70.422",	"I70.423",	"I70.428",	"I70.429",	"I70.43",	"I70.431",	
  "I70.432",	"I70.433",	"I70.434",	"I70.435",	"I70.438",	"I70.439",	"I70.44",	"I70.441",	"I70.442",	"I70.443",	"I70.444",	"I70.445",	"I70.448",	"I70.449",
  "I70.45",	"I70.46",	"I70.461",	"I70.462",	"I70.463",	"I70.468",	"I70.469",	"I70.49",	"I70.491",	"I70.492",	"I70.493",	"I70.498",	"I70.499",	"I70.5",	
  "I70.50",	"I70.501",	"I70.502",	"I70.503",	"I70.508",	"I70.509",	"I70.51",	"I70.511",	"I70.512",	"I70.513",	"I70.518",	"I70.519",	"I70.52",	"I70.521",
  "I70.522",	"I70.523",	"I70.528",	"I70.529",	"I70.53",	"I70.531",	"I70.532",	"I70.533",	"I70.534",	"I70.535",	"I70.538",	"I70.539",	"I70.54",	"I70.541",
  "I70.542",	"I70.543",	"I70.544",	"I70.545",	"I70.548",	"I70.549",	"I70.55",	"I70.56",	"I70.561",	"I70.562",	"I70.563",	"I70.568",	"I70.569",	"I70.59",	
  "I70.591",	"I70.592",	"I70.593",	"I70.598",	"I70.599",	"I70.6",	"I70.60",	"I70.601",	"I70.602",	"I70.603",	"I70.608",	"I70.609",	"I70.61",	"I70.611",	
  "I70.612",	"I70.613",	"I70.618",	"I70.619",	"I70.62",	"I70.621",	"I70.622",	"I70.623",	"I70.628",	"I70.629",	"I70.63",	"I70.631",	"I70.632",	"I70.633",
  "I70.634",	"I70.635",	"I70.638",	"I70.639",	"I70.64",	"I70.641",	"I70.642",	"I70.643",	"I70.644",	"I70.645",	"I70.648",	"I70.649",	"I70.65",	"I70.66",	
  "I70.661",	"I70.662",	"I70.663",	"I70.668",	"I70.669",	"I70.69",	"I70.691",	"I70.692",	"I70.693",	"I70.698",	"I70.699",	"I70.7",	"I70.70",	"I70.701",	
  "I70.702",	"I70.703",	"I70.708",	"I70.709",	"I70.71",	"I70.711",	"I70.712",	"I70.713",	"I70.718",	"I70.719",	"I70.72",	"I70.721",	"I70.722",	"I70.723",	
  "I70.728",	"I70.729",	"I70.73",	"I70.731",	"I70.732",	"I70.733",	"I70.734",	"I70.735",	"I70.738",	"I70.739",	"I70.74",	"I70.741",	"I70.742",	"I70.743",	
  "I70.744",	"I70.745",	"I70.748",	"I70.749",	"I70.75",	"I70.76",	"I70.761",	"I70.762",	"I70.763",	"I70.768",	"I70.769",	"I70.79",	"I70.791",	"I70.792",	
  "I70.793",	"I70.798",	"I70.799",	"I70.8",	"I70.9",	"I70.90",	"I70.91",	"I70.92",	"I73",	"I73.0",	"I73.00",	"I73.01",	"I73.1",	"I73.8",	"I73.81",	"I73.89",	
  "I73.9",	"I77.1",	"I79.0"
)
###########
pre_index<-function(var,icd){
  ICD_Patients_ENCS%>%
    mutate(!!enquo(var) := if_else(ICD_CD %in% icd & ENC_DT < INDEX_DT,1,0))%>%
    filter(!!enquo(var) == 1)%>%
    select("PT_ID",!!enquo(var))%>%
    distinct()
}
at_index<-function(var,icd){
  ICD_Patients_ENCS%>%
    mutate(!!enquo(var) := if_else(ICD_CD %in% icd & ENC_DT <= INDEX_DT,1,0))%>%
    filter(!!enquo(var) == 1)%>%
    select("PT_ID",!!enquo(var))%>%
    distinct()
  }
all_time<-function(var,icd){
  ICD_Patients_ENCS%>%
    mutate(!!enquo(var) := if_else(ICD_CD %in% icd,1,0))%>%
    filter((!!enquo(var)) == 1)%>%
    select("PT_ID",!!enquo(var))%>%
    distinct()
  }
GNSIS.1<-inner_join(
                 # Replace only the missing values in Durgesh's labs with Jiang's imputed lab values
                 left_join(GNSIS.1,
                            jiang.labs,
                            by = "PT_ID")%>%
                   mutate(                                                                       
                     HB_CLOSEST_TO_INDEX=coalesce(HB_CLOSEST_TO_INDEX.x,HB_CLOSEST_TO_INDEX.y),
                     HBA1C_CLOSEST_TO_INDEX=coalesce(HBA1C_CLOSEST_TO_INDEX.x,HBA1C_CLOSEST_TO_INDEX.y),
                     HDL_CLOSEST_TO_INDEX=coalesce(HDL_CLOSEST_TO_INDEX.x,HDL_CLOSEST_TO_INDEX.y),
                     LDL_CLOSEST_TO_INDEX=coalesce(LDL_CLOSEST_TO_INDEX.x,LDL_CLOSEST_TO_INDEX.y),
                     PLT_CLOSEST_TO_INDEX=coalesce(PLT_CLOSEST_TO_INDEX.x,PLT_CLOSEST_TO_INDEX.y),
                     WBC_CLOSEST_TO_INDEX=coalesce(WBC_CLOSEST_TO_INDEX.x,WBC_CLOSEST_TO_INDEX.y),
                     CREATININE_CLOSEST_TO_INDEX=coalesce(CREATININE_CLOSEST_TO_INDEX.x,CREATININE_CLOSEST_TO_INDEX.y)
                   ),
                 # Create new binary variables for the Comorbidities and merge with the main GNSIS database
                 left_join(GNSIS.1["PT_ID"],
                           ICD_Patients_ENCS%>%
                             mutate(AFIB_FLUTTER_AT_INDEX_3yrsPost=if_else(ICD_CD %in% icd_AFIB_FLUTTER & ENC_DT < (INDEX_DT+years(3)),1,0))%>%
                             filter(AFIB_FLUTTER_AT_INDEX_3yrsPost==1)%>%
                             select("PT_ID","AFIB_FLUTTER_AT_INDEX_3yrsPost")%>%
                             distinct(), 
                           by = "PT_ID")%>%
                   left_join(., pre_index(PREECLAMPSIA_PRE_INDEX, icd_PREECLAMPSIA),by="PT_ID")%>%
                   left_join(., at_index(CERVICOCEPHALIC_ARTERIAL_DISSECTION_AT_INDEX, icd_CERVICOCEPHALIC), by = "PT_ID")%>%
                   left_join(., all_time(CERVICOCEPHALIC_ARTERIAL_DISSECTION_ALL_TIME, icd_CERVICOCEPHALIC), by = "PT_ID")%>%
                   left_join(., all_time(CEREBRAL_AMYLOID_ANGIOPATHY_ALL_TIME, icd_CEREBRAL_AMYLOID), by = "PT_ID")%>%
                   left_join(., all_time(MOYAMOYA_ALL_TIME, icd_MOYAMOYA), by = "PT_ID")%>%
                   left_join(., all_time(FIBROMUSCULAR_DYSPLASIA_ALL_TIME, icd_FIBROMUSCULAR), by = "PT_ID")%>%
                   left_join(., all_time(SUSAC_SYNDROME_ALL_TIME, icd_SUSAC_SYNDROME), by = "PT_ID")%>%
                   left_join(., all_time(SICKLE_CELL_ALL_TIME, icd_SICKLE_CELL), by = "PT_ID")%>%
                   left_join(., all_time(CADASIL_ALL_TIME, icd_CADASIL), by = "PT_ID")%>%
                   #left_join(., all_time(MELAS_ALL_TIME, icd_MELAS), by = "PT_ID")%>%
                   #left_join(., all_time(MARFAN_SYNDROME, icd_MARFAN_SYNDROME), by = "PT_ID")%>%
                   #left_join(., all_time(NEUROFIBROMATOSIS, icd_NEUROFIBROMATOSIS), by = "PT_ID")%>%
                   #left_join(., all_time(STURGE_WEBER_ALL_TIME, icd_STURGE_WEBER_DISEASE), by = "PT_ID")%>%
                   #left_join(., at_index(REVERSIBLE_CEREBRAL_VASOCONSTRICTION_SYNDROME_AT_INDEX, icd_REVERSIBLE_CEREBRAL), by = "PT_ID")%>%
                   #left_join(., all_time(REVERSIBLE_CEREBRAL_VASOCONSTRICTION_SYNDROME_ALL_TIME, icd_REVERSIBLE_CEREBRAL), by = "PT_ID")%>%
                   #left_join(., all_time(SNEDDON_SYNDROME_ALL_TIME, icd_SNEDDON_SYNDROME), by = "PT_ID")%>%
                   #left_join(., all_time(FABRY_ALL_TIME, icd_FABRY_DISEASE), by = "PT_ID")%>%
                   #left_join(., all_time(VASCULITIS_ALL_TIME, icd_VASCULITIS), by = "PT_ID")%>%
                   #left_join(., all_time(TEMPORAL_ARTERITIS_ALL_TIME, icd_TEMPORAL_ARTERITIS), by = "PT_ID")%>%
                   #left_join(., all_time(TAKAYASU_ALL_TIME, icd_TAKAYASU_DISEASE), by = "PT_ID")%>%
                   #left_join(., all_time(NEUROSARCOIDOSIS_ALL_TIME, icd_NEUROSARCOIDOSIS), by = "PT_ID")%>%
                   #left_join(., at_index(NEUROSYPHILIS_AT_INDEX, icd_NEUROSYPHILIS), by = "PT_ID")%>%
                   #left_join(., all_time(NEUROSYPHILIS_ALL_TIME, icd_NEUROSYPHILIS), by = "PT_ID")%>%
                   #left_join(., at_index(TUBERCULOUS_MENINGITIS_AT_INDEX, icd_TB_MENINGITIS), by = "PT_ID")%>%
                   #left_join(., all_time(TUBERCULOUS_MENINGITIS_ALL_TIME, icd_TB_MENINGITIS), by = "PT_ID")%>%
                   #left_join(., at_index(VASCULITIS_AT_INDEX, icd_VASCULITIS), by = "PT_ID")%>%
                   left_join(., all_time(BEHCET_SYNDROME_ALL_TIME, icd_BEHCET_SYNDROME), by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(HIV_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_HIV & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(HIV_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","HIV_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(RHEUM_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_RHEUM & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(RHEUM_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","RHEUM_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(REVERSIBLE_CEREBRAL_VASOCONSTRICTION_SYNDROME_AT_INDEX_3monthsPost = if_else(
                                 ICD_CD %in% icd_CEREBRAL_VASOCONSTRICTION & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(REVERSIBLE_CEREBRAL_VASOCONSTRICTION_SYNDROME_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","REVERSIBLE_CEREBRAL_VASOCONSTRICTION_SYNDROME_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(HYPERCOAG_STATES_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_HYPERCOAG & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(HYPERCOAG_STATES_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","HYPERCOAG_STATES_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(TEMPORAL_ARTERITIS_AT_INDEX_1monthPost = if_else(
                                 ICD_CD %in% icd_TEMPORAL_ARTERITIS & ENC_DT < (INDEX_DT+months(1)),1,0))%>%
                               filter(TEMPORAL_ARTERITIS_AT_INDEX_1monthPost==1)%>%
                               select("PT_ID","TEMPORAL_ARTERITIS_AT_INDEX_1monthPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(TEMPORAL_ARTERITIS_AT_INDEX_3monthsPost = if_else(
                                 ICD_CD %in% icd_TEMPORAL_ARTERITIS & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(TEMPORAL_ARTERITIS_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","TEMPORAL_ARTERITIS_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(AFIB_FLUTTER_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_AFIB_FLUTTER & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(AFIB_FLUTTER_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","AFIB_FLUTTER_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(CIRRHOSIS_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_CIRRHOSIS & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(CIRRHOSIS_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","CIRRHOSIS_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(NEOPLASM_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_NEOPLASM & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(NEOPLASM_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","NEOPLASM_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(PERI_VASC_DIS_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_PERIVASC & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(PERI_VASC_DIS_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","PERI_VASC_DIS_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., ICD_Patients_ENCS%>%
                               mutate(VASCULITIS_AT_INDEX_3monthsPost = if_else(ICD_CD %in% icd_VASCULITIS & ENC_DT < (INDEX_DT+months(3)),1,0))%>%
                               filter(VASCULITIS_AT_INDEX_3monthsPost==1)%>%
                               select("PT_ID","VASCULITIS_AT_INDEX_3monthsPost")%>%
                               distinct(), 
                             by = "PT_ID")%>%
                   left_join(., at_index(VARICELLA_ZOSTER_VIRUS_AT_INDEX, icd_VARICELLA_ZOSTER_VIRUS), by = "PT_ID")%>%
                   left_join(., all_time(VARICELLA_ZOSTER_VIRUS_ALL_TIME, icd_VARICELLA_ZOSTER_VIRUS), by = "PT_ID")%>%
                   replace(is.na(.),0),
                by = "PT_ID"
                )
#######################
# Create new variables
######################
selected_features<-c(
  "AFIB_FLUTTER_AT_INDEX_3monthsPost",
  "AFIB_FLUTTER_AT_INDEX",
  "AFIB_FLUTTER_AT_INDEX_3yrsPost",
  "ALCOHOL_DEP_ABUSE_AT_INDEX",
  "ANXIETY_DIS_AT_INDEX",
  "BRAIN_TUMOR_AT_INDEX",
  "CERVICOCEPHALIC_ARTERIAL_DISSECTION_AT_INDEX",
  "CHF_AT_INDEX",
  "CHRONIC_KIDNEY_DIS_AT_INDEX",
  "CHRONIC_LIVER_DIS_AT_INDEX",
  "CHRONIC_LUNG_DIS_AT_INDEX",
  "CIRRHOSIS_AT_INDEX_3monthsPost",
  "CONVERSION_DIS_AT_INDEX",
  "CONVULSIONS_AT_INDEX",
  "DEPRESSION_AT_INDEX",
  "DIABETES_AT_INDEX",
  "DRUG_DEP_ABUSE_AT_INDEX",
  "DYSLIPIDEMIA_AT_INDEX",
  "EPILEPSY_AT_INDEX",
  "ESRD_AT_INDEX",
  "FAM_HEART_HIST",
  "FAM_STROKE_HIST",
  "FIBROMUSCULAR_DYSPLASIA_ALL_TIME",
  "HEPATIC_ENCEPHALOPATHY_AT_INDEX",
  "HIV_AT_INDEX_3monthsPost",
  "HYPERCOAG_STATES_AT_INDEX_3monthsPost",
  "HYPERTENSION_AT_INDEX",
  "MANIC_BIPOLAR_DIS_AT_INDEX",
  "MI_AT_INDEX",
  "MIGRAINE_AT_INDEX",
  "MOYAMOYA_ALL_TIME",
  "NEOPLASM_AT_INDEX_3monthsPost",
  "PERI_VASC_DIS_AT_INDEX_3monthsPost",
  "PERIPHERAL_NEUROPATHY_AT_INDEX",
  "PFO_ALL_TIME",
  "PT_SEX",
  "REVERSIBLE_CEREBRAL_VASOCONSTRICTION_SYNDROME_AT_INDEX_3monthsPost",
  "RHEUM_AT_INDEX_3monthsPost",
  "SICKLE_CELL_ALL_TIME",
  "SMOKE_STTS",
  "SYNCOPE_AT_INDEX",
  "TEMPORAL_ARTERITIS_AT_INDEX_3monthsPost",
  "VARICELLA_ZOSTER_VIRUS_AT_INDEX",
  "VASCULITIS_AT_INDEX_3monthsPost",
  "BMI_CLOSEST_TO_INDEX",
  "LDL_CLOSEST_TO_INDEX",
  "HBA1C_CLOSEST_TO_INDEX",
  "HDL_CLOSEST_TO_INDEX",
  "HB_CLOSEST_TO_INDEX",
  "PLT_CLOSEST_TO_INDEX",
  "CREATININE_CLOSEST_TO_INDEX",
  "AGE_AT_INDEX"
  )
######################
# raw GNSIS with continuous vars
GNSIS.1<-GNSIS.1%>%
  mutate(DRUG_DEP_ABUSE_AT_INDEX = if_else((OPIOID_DEP_ABUSE_AT_INDEX == 1 | CANNABIS_DEP_ABUSE_AT_INDEX == 1 | 
                                            COCAINE_DEP_ABUSE_AT_INDEX == 1 | OTHER_DRUG_DEP_ABUSE_AT_INDEX==1),1,0),
         PT_SEX = if_else(PT_SEX %in% 'Male',1,0),
         SMOKE_STTS = if_else(SMOKE_STTS %in% 'CURRENT SMOKER',1,0),
         THROMBECTOMY_YN = if_else(THROMBECTOMY_YN == 'Y',1,0)
    )%>%
  select(all_of(selected_features))
# only binary vars
GNSIS.2<-GNSIS.1%>%
  mutate(
    BMI_CLOSEST_TO_INDEX_BINARY=if_else(BMI_CLOSEST_TO_INDEX>25,1,0),
    LDL_CLOSEST_TO_INDEX_BINARY=if_else(LDL_CLOSEST_TO_INDEX>100,1,0),
    HBA1C_CLOSEST_TO_INDEX_BINARY=if_else(HBA1C_CLOSEST_TO_INDEX>6.5,1,0),
    HDL_CLOSEST_TO_INDEX_BINARY=if_else(HDL_CLOSEST_TO_INDEX>40,1,0),
    PLT_CLOSEST_TO_INDEX_BINARY=if_else(PLT_CLOSEST_TO_INDEX>450,1,0),
    HB_CLOSEST_TO_INDEX_BINARY=if_else(
      ((PT_SEX==1 & HB_CLOSEST_TO_INDEX>=13.5 & HB_CLOSEST_TO_INDEX<=17.5)|
         (PT_SEX==0 & HB_CLOSEST_TO_INDEX>=12 & HB_CLOSEST_TO_INDEX<=15.5)),0,1),
    CREATININE_CLOSEST_TO_INDEX_BINARY=if_else(
      ((PT_SEX==1 & CREATININE_CLOSEST_TO_INDEX<=1.4)|
          (PT_SEX==0 & CREATININE_CLOSEST_TO_INDEX<=1.2)),0,1)
  )%>%
  select(-c("BMI_CLOSEST_TO_INDEX",
            "LDL_CLOSEST_TO_INDEX",
            "HBA1C_CLOSEST_TO_INDEX",
            "HDL_CLOSEST_TO_INDEX",
            "HB_CLOSEST_TO_INDEX",
            "PLT_CLOSEST_TO_INDEX",
            "CREATININE_CLOSEST_TO_INDEX"))
#############
# Imputation
############
library(mice)
data.frame(sapply(GNSIS.1, function(x) sum(is.na(x))))%>%
  filter_all(all_vars(.>0))
mice.GNSIS.1<-mice(GNSIS.1, m = 25,maxit = 25, method = "pmm", seed = 99)
mice.GNSIS.2<-mice(GNSIS.2, m = 25,maxit = 25, method = "pmm", seed = 99)
# imputed data with continuous variables and then converted to binary vars
GNSIS.1<-mice::complete(mice.GNSIS.1)%>%
  mutate(
    BMI_CLOSEST_TO_INDEX_BINARY=if_else(BMI_CLOSEST_TO_INDEX>25,1,0),
    LDL_CLOSEST_TO_INDEX_BINARY=if_else(LDL_CLOSEST_TO_INDEX>100,1,0),
    HBA1C_CLOSEST_TO_INDEX_BINARY=if_else(HBA1C_CLOSEST_TO_INDEX>6.5,1,0),
    HDL_CLOSEST_TO_INDEX_BINARY=if_else(HDL_CLOSEST_TO_INDEX>40,1,0),
    PLT_CLOSEST_TO_INDEX_BINARY=if_else(PLT_CLOSEST_TO_INDEX>450,1,0),
    HB_CLOSEST_TO_INDEX_BINARY=if_else(
      ((PT_SEX==1 & HB_CLOSEST_TO_INDEX>=13.5 & HB_CLOSEST_TO_INDEX<=17.5)|
         (PT_SEX==0 & HB_CLOSEST_TO_INDEX>=12 & HB_CLOSEST_TO_INDEX<=15.5)),0,1),
    CREATININE_CLOSEST_TO_INDEX_BINARY=if_else(
      ((PT_SEX==1 & CREATININE_CLOSEST_TO_INDEX<=1.4)|
         (PT_SEX==0 & CREATININE_CLOSEST_TO_INDEX<=1.2)),0,1)
  )%>%
  select(-c("BMI_CLOSEST_TO_INDEX",
            "LDL_CLOSEST_TO_INDEX",
            "HBA1C_CLOSEST_TO_INDEX",
            "HDL_CLOSEST_TO_INDEX",
            "HB_CLOSEST_TO_INDEX",
            "PLT_CLOSEST_TO_INDEX",
            "CREATININE_CLOSEST_TO_INDEX"))
# converted to binary vars then imputed data with all binary variables
GNSIS.2<-mice::complete(mice.GNSIS.2)
################
# Summary stats
###############
binaryCols<-names(Filter(function(x) x,apply(GNSIS.2,2,function(x) { all(x %in% 0:1) })))
not.na = function(x) {sum(!is.na(x))}
tmp<-t(GNSIS%>%
         select(-c('PT_ID','INDEX_DT',binaryCols))%>%
         #group_by(.)%>%
         group_by(n=n())%>% # to get length
         summarize_all(.,
                       funs(
                         missing = sum(is.na(.)),
                         mean = mean,
                         q25 = quantile(.,c(.25)),
                         q75 = quantile(.,c(.75)),
                         sd = sd
                       ),
                       na.rm=T))%>%
      round(.,0)
tmp<-t(GNSIS%>%filter(PT_SEX == 0)%>%
  select(binaryCols)%>%
  group_by(n=n())%>%
  summarise_all(.,list(sum)))
A<-subset(GNSIS,INDEX_DT<='2011-12-31')
B<-subset(GNSIS,INDEX_DT>'2011-12-31')

sum.stats.cont.vars<-function(dat,gender,age){
  t(dat%>%
    filter(PT_SEX==gender & AGE_AT_INDEX>age)%>%
    select(-c('PT_ID','INDEX_DT',binaryCols))%>%
    group_by(n=n())%>% 
    summarize_all(.,
                  funs(
                    missing = sum(is.na(.)),
                    mean = mean,
                    q25 = quantile(.,c(.25)),
                    q75 = quantile(.,c(.75)),
                    sd = sd,
                    median=median
                  ),
                  na.rm=T))%>%
  round(.,3)
}
sum.stats.binary.vars<-function(dat,gender,age){
  t(dat%>%
      filter(PT_SEX == gender & AGE_AT_INDEX>age)%>%
      select(binaryCols)%>%
      group_by(n=n())%>%
      summarise_all(.,list(sum)))
}
tmp<-cbind(sum.stats.binary.vars(GNSIS.1,1,40),
           sum.stats.binary.vars(GNSIS.1,1,45),
           sum.stats.binary.vars(GNSIS.1,1,50),
           sum.stats.binary.vars(GNSIS.1,1,55),
           sum.stats.binary.vars(GNSIS.1,1,60),
           sum.stats.binary.vars(GNSIS.1,1,65)
           )
tmp<-cbind(sum.stats.binary.vars(GNSIS.1,0,40),
           sum.stats.binary.vars(GNSIS.1,0,45),
           sum.stats.binary.vars(GNSIS.1,0,50),
           sum.stats.binary.vars(GNSIS.1,0,55),
           sum.stats.binary.vars(GNSIS.1,0,60),
           sum.stats.binary.vars(GNSIS.1,0,65)
)

#############
# Clustering
############
library(cluster)
library(factoextra)
library(dendextend)
d<-dist(GNSIS.1, method = "euclidean")
fit.c<-hclust(d,method = "complete")
fit.d2<-hclust(d,method = "ward.D2")
sub_grp <- cutree(fit.d2, k = 4)
table(sub_grp)
tmp<-subset(GNSIS.1,AGE_AT_INDEX<65) %>%
  mutate(cluster = sub_grp)%>%
  select(cluster,everything())
plot(fit, cex = 0.6, hang = -1)
fviz_cluster(list(data = GNSIS.1, cluster = sub_grp))
fviz_nbclust(GNSIS.1, FUN = hcut, method = "wss")                               # find no.of optimal clusters: Elbow method
fviz_nbclust(GNSIS.1, FUN = hcut, method = "silhouette")                        # find no.of optimal clusters: Avg silhouette method
fviz_gap_stat(clusGap(GNSIS.1, FUN = hcut, nstart = 25, K.max = 10, B = 50))    # find no.of optimal clusters: Gap statistic method
tanglegram(as.dendrogram(fit.c),as.dendrogram(fit.d2))
par(mar=c(7,3,1,1))                                                             # increase bottom margin to see labels
plot(subset(GNSIS.1,AGE_AT_INDEX<45)%>%                                         # visualize no.of clusters using dendrogram
       dist()%>%
       hclust()%>%
       as.dendrogram())
# apply age filters
d<-dist(subset(GNSIS.1,AGE_AT_INDEX<65), method = "euclidean")
fit.c<-hclust(d,method = "complete")
fit.d2<-hclust(d,method = "ward.D2")
sub_grp <- cutree(fit.d2, k = 2)
fviz_cluster(list(data = subset(GNSIS.1,AGE_AT_INDEX<65), cluster = sub_grp))
fig1.65<-fviz_nbclust(subset(GNSIS.1,AGE_AT_INDEX<65), FUN = hcut, method = "wss")
fig2.65<-fviz_nbclust(subset(GNSIS.1,AGE_AT_INDEX<65), FUN = hcut, method = "silhouette")
fig3.65<-fviz_gap_stat(clusGap(subset(GNSIS.1,AGE_AT_INDEX<65), FUN = hcut, nstart = 25, K.max = 10, B = 50))
d<-get_dist(subset(GNSIS.1,AGE_AT_INDEX<65))
fviz_dist(d, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07")) # visualize distance matrix
k65<-kmeans(subset(GNSIS.1,AGE_AT_INDEX<65), centers = 2, nstart = 25)
p1<-fviz_cluster(kmeans(subset(GNSIS.1,AGE_AT_INDEX<65), centers = 3, nstart = 25), 
             data = subset(GNSIS.1,AGE_AT_INDEX<65),
             geom = "point"
             )+
  ggtitle("k=3")
p2<-fviz_cluster(kmeans(subset(GNSIS.1,AGE_AT_INDEX<65), centers = 2, nstart = 25), 
             data = subset(GNSIS.1,AGE_AT_INDEX<65),
             geom = "point"
)+
  ggtitle("k=2")
p3<-fviz_cluster(kmeans(subset(GNSIS.1,AGE_AT_INDEX<65), centers = 4, nstart = 25), 
                 data = subset(GNSIS.1,AGE_AT_INDEX<65),
                 geom = "point"
)+
  ggtitle("k=4")
p4<-fviz_cluster(kmeans(subset(GNSIS.1,AGE_AT_INDEX<65), centers = 5, nstart = 25), 
                 data = subset(GNSIS.1,AGE_AT_INDEX<65),
                 geom = "point"
)+
  ggtitle("k=5")
library(gridExtra)
grid.arrange(p1,p2,p3,p4,nrow=2)

dev.off()
par(mar=c(10, 4, 3, 0.5), mgp=c(0, 0.8, -0.5), cex=0.9)
dev.new(width=10, height=10)
par(mar=c(10,4,4,2)+.1) # bottom, left, top, and right
par(mar=c(30,30,30,30))
tiff("all.tiff",units = "in", width = 12, height = 6.8, res = 300)
heatmap.2(
  t(GNSIS.1 %>% 
      #filter(PT_SEX == 1) %>%
      select(-c(AGE_AT_INDEX))
    ),
  margins = c(2,20),
  main = "GNSIS",
  density.info = "none",
  trace = "none",
  cexRow = .55
)
dev.off()




# A connection data frame is a list of flows with intensity for each flow
links <- data.frame(
  source=c("group_A","group_A", "group_B", "group_C", "group_C", "group_E"), 
  target=c("group_C","group_D", "group_E", "group_F", "group_G", "group_H"), 
  value=c(2,3, 2, 3, 1, 3)
)

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(
  name=c(as.character(links$source), 
         as.character(links$target)) %>% unique()
)

# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

sankeyNetwork(Links = links, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", 
              sinksRight=FALSE)





##########
# TESTING
#########
tmp<-left_join(GNSIS["PT_ID"],
               ICD_Patients_ENCS%>%
                 mutate(AFIB_FLUTTER_AT_INDEX_3yrsPost=if_else(ICD_CD %in% icd_AFIB_FLUTTER & ENC_DT < (INDEX_DT+years(3)),1,0))%>%
                 filter(AFIB_FLUTTER_AT_INDEX_3yrsPost==1)%>%
                 select("PT_ID","AFIB_FLUTTER_AT_INDEX_3yrsPost")%>%
                 distinct(), 
               by="PT_ID")%>%
  left_join(., pre_index(PREECLAMPSIA_PRE_INDEX, icd_PREECLAMPSIA),by="PT_ID")%>%
  left_join(., at_index(CERVICOCEPHALIC_ARTERIAL_DISSECTION_AT_INDEX, icd_CERVICOCEPHALIC), by = "PT_ID")%>%
  left_join(., all_time(CEREBRAL_AMYLOID_ANGIOPATHY_ALL_TIME, icd_CEREBRAL_AMYLOID), by = "PT_ID")%>%
  left_join(., all_time(MOYAMOYA_ALL_TIME, icd_MOYAMOYA), by = "PT_ID")%>%
  left_join(., all_time(FIBROMUSCULAR_DYSPLASIA_ALL_TIME, icd_FIBROMUSCULAR), by = "PT_ID")%>%
  left_join(., at_index(REVERSIBLE_CEREBRAL_VASOCONSTRICTION_SYNDROME_AT_INDEX, icd_REVERSIBLE_CEREBRAL), by = "PT_ID")%>%
  left_join(., all_time(SUSAC_SYNDROME_ALL_TIME, icd_SUSAC_SYNDROME), by = "PT_ID")%>%
  #left_join(., all_time(SNEDDON_SYNDROME_ALL_TIME, icd_SNEDDON_SYNDROME), by = "PT_ID")%>%
  left_join(., all_time(SICKLE_CELL_ALL_TIME, icd_SICKLE_CELL), by = "PT_ID")%>%
  left_join(., all_time(FABRY_ALL_TIME, icd_FABRY_DISEASE), by = "PT_ID")%>%
  left_join(., all_time(CADASIL_ALL_TIME, icd_CADASIL), by = "PT_ID")%>%
  left_join(., all_time(MELAS_ALL_TIME, icd_MELAS), by = "PT_ID")%>%
  #left_join(., all_time(MARFAN_SYNDROME, icd_MARFAN_SYNDROME), by = "PT_ID")%>%
  left_join(., all_time(NEUROFIBROMATOSIS, icd_NEUROFIBROMATOSIS), by = "PT_ID")%>%
  left_join(., all_time(STURGE_WEBER_ALL_TIME, icd_STURGE_WEBER_DISEASE), by = "PT_ID")%>%
  left_join(., at_index(VASCULITIS_AT_INDEX, icd_VASCULITIS), by = "PT_ID")%>%
  left_join(., all_time(TEMPORAL_ARTERITIS_ALL_TIME, icd_TEMPORAL_ARTERITIS), by = "PT_ID")%>%
  left_join(., all_time(TAKAYASU_ALL_TIME, icd_TAKAYASU_DISEASE), by = "PT_ID")%>%
  #left_join(., all_time(BEHCET_SYNDROME_ALL_TIME, icd_BEHCET_SYNDROME), by = "PT_ID")%>%
  left_join(., all_time(NEUROSARCOIDOSIS_ALL_TIME, icd_NEUROSARCOIDOSIS), by = "PT_ID")%>%
  left_join(., ICD_Patients_ENCS%>%
              mutate(HIV_AT_INDEX = if_else(ICD_CD %in% icd_HIV & ENC_DT < (INDEX_DT+days(14)),1,0))%>%
              filter(HIV_AT_INDEX==1)%>%
              select("PT_ID","HIV_AT_INDEX")%>%
              distinct(), 
            by = "PT_ID")%>%
  left_join(., at_index(VARICELLA_ZOSTER_VIRUS_AT_INDEX, icd_VARICELLA_ZOSTER_VIRUS), by = "PT_ID")%>%
  left_join(., at_index(NEUROSYPHILIS_AT_INDEX, icd_NEUROSYPHILIS), by = "PT_ID")%>%
  left_join(., at_index(TUBERCULOUS_MENINGITIS_AT_INDEX, icd_TB_MENINGITIS), by = "PT_ID")%>%
  replace(is.na(.),0)
